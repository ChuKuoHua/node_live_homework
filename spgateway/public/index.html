<!DOCTYPE html>
<html>
  <head>
    <title><%= title %></title>
    <link rel="stylesheet" href="/stylesheets/style.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.27.2/axios.min.js"></script>
  </head>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
  <body>
    <div id="app">
      <div class="row mb-1">
        <div class="col-6">
          <h1 class="h5">建立訂單</h1>
          <form @submit.prevent="createOrder">
            <div class="mb-1 input-group">
              <span class="input-group-text">email</span>            <input class="form-control" type="email" v-model="addOrder.Email">
            </div>
            <div class="mb-1 input-group">
              <span class="input-group-text">價格</span>
              <input class="form-control" type="number" v-model.number="addOrder.Amt">
            </div>
            <div class="mb-1 input-group">
              <span class="input-group-text">訂單資訊</span>
              <input class="form-control" type="text" v-model="addOrder.ItemDesc">
            </div>
            <button class="btn btn-outline-warning" type="submit">送出</button>
          </form>
        </div>
        <div class="col-6"></div>
        <hr class="my-3">
        <div class="col-12">
          <h2 class="h5">藍新付款</h2>
        </div>
        <div class="col-6">
          
          <p>Axios 打藍新 api (會遇到 cors 跨域問題)</p>
          <ul class="list-group mb-1">
            <li class="list-group-item">
              
              <p>TimeStamp： 1684224973</p>
            </li>
            <li class="d-none list-group-item">
              <p>MerchantID： MS148916579</p>
            </li>
            <li class="d-none list-group-item">
              <p>TradeSha： D7BAB6355B86533B42C8D7E41809720F2308B19392996ADE1F084A266DC2222F</p>
            </li>
            <li class="d-none list-group-item">
              <p class="text-break">TradeInfo：d8f663697c387ba25324ba3f6434f2e46f1291d6e3c1dc6611c185ebc1ffb7afebc7e7b7bb70c8220e4e93536a04d944742ec8854f7d225dc08220c77a1964f0284ca94cd55586e070252dfca175ddf49f25c6d711aa20ac1ab38a1ad617427d35f5015ca9772b1420e4b19378b6ae15375e583010a5d07e363c8b77d4555409cb85613cae39f811507bbfc54830a1bae7affc2ed3640f4cb072839968786080</p>
            </li>
            <li class="d-none list-group-item">
              <p>Version： 1.5</p>
            </li>
            <li class="list-group-item">
              <p>MerchantOrderNo： 1684224973</p>
            </li>
            <li class="list-group-item">
              <p>Amt： 255</p>
            </li>
            <li class="list-group-item">
              <p>Email： 1@gmail.com</p>
            </li>
            <li class="list-group-item">
              <button
                class="btn btn-success w-50"
                type="button"
                @click="send()">付款</button>
            </li>
          </ul>
        </div>
        <div class="col-6">
          <p>Form 打藍新 api</p>
          <form
            action="https://ccore.newebpay.com/MPG/mpg_gateway"
            method="post"
          >
            <div class="mb-1 input-group">
              <span class="input-group-text">MerchantID</span>
              <input
                type="text"
                class="form-control"
                id="MerchantID"
                name="MerchantID"
                value="MS148916579">
            </div>
            <div class="mb-1 input-group">
              <span class="input-group-text">TradeSha</span>
              <input
                type="text"
                class="form-control"
                id="TradeSha" 
                name="TradeSha"
                v-model.number="order.TradeSha">
            </div>
            <div class="mb-1 input-group">
              <span class="input-group-text">TradeInfo</span>
              <input
                name="TradeInfo"
                type="text"
                class="form-control"
                id="TradeInfo"
                v-model.number="order.TradeInfo">
            </div>
            <div class="mb-1 input-group">
              <span class="input-group-text">TimeStamp</span>
              <input
                type="text"
                class="form-control"
                id="TimeStamp"
                name="TimeStamp"
                v-model.number="order.TimeStamp">
            </div>
            <div class="mb-1 input-group">
              <span class="input-group-text">Version</span>
              <input
                type="text"
                class="form-control"
                id="Version"
                value="1.5"
                name="Version"
              >
            </div>
            <div class="mb-1 input-group">
              <span class="input-group-text">MerchantOrderNo</span>
              <input
                type="text"
                class="form-control"
                id="MerchantOrderNo"
                v-model.number="order.MerchantOrderNo"
                name="MerchantOrderNo"
              >
            </div>
            <div class="mb-1 input-group">
              <span class="input-group-text">Amt</span>
              <input
                type="text"
                class="form-control"
                id="Amt"
                v-model.number="order.Amt"
                name="Amt"
              >
            </div>
            <div class="mb-1 input-group">
              <span class="input-group-text">Email</span>
              <input
                type="text"
                class="form-control"
                id="Email"
                v-model.number="order.Email"
                name="Email"
              >
            </div>
            <button class="btn btn-success w-50" type="submit">付款</button>
          </form>
        </div>
      </div>
    </div>

    <script type="module">
      import { createApp } from 'https://cdnjs.cloudflare.com/ajax/libs/vue/3.2.37/vue.esm-browser.min.js';
      const app = {
        data() {
          return {
            addOrder: {
              Email: '',
              Amt: 1200,
              ItemDesc: '大港音樂祭'
            },
            order: {
              MerchantOrderNo: '',
              Amt: '',
              Email: '',
              ItemDesc: '',
              TradeSha: '',
              TradeInfo: '',
              TimeStamp: '',
            },
            orderId: '',
          };
        },
        methods: {
          async createOrder() {
            const url = '/api/createOrder';
            const res = await axios.post(url, this.addOrder).then(res => {
              const data = res.data
              for(let key in this.order) {
                this.order[key] = data.order[key]
              }
              console.log(data);
              this.order['TradeSha'] = data['TradeSha']
              this.order['TradeInfo'] = data['TradeInfo']
            });
          },
          send() {
            const formData = new FormData();
            formData.append('MerchantID', this.order.MerchantID)
            formData.append('Version', this.order.Version)
            formData.append('MerchantOrderNo', this.order.MerchantOrderNo)
            formData.append('Amt', this.order.Amt)
            formData.append('Email', this.order.Email)
            formData.append('ItemDesc', this.order.ItemDesc)
            formData.append('TradeSha', this.order.TradeSha)
            formData.append('TradeInfo', this.order.TradeInfo);

            axios.post('https://ccore.newebpay.com/MPG/mpg_gateway', formData, {
              headers: {
                'Content-Type': 'multipart/form-data'
              }
            }).then(v => {
              console.log(v.data);
              res.send(v.data)
            })

            // const formData = {
            //   MerchantID: this.order.MerchantID,
            //   Version: this.order.Version,
            //   MerchantOrderNo: this.order.MerchantOrderNo,
            //   Amt: this.order.Amt,
            //   Email: this.order.Email,
            //   ItemDesc: this.order.ItemDesc,
            //   TradeSha: this.order.TradeSha,
            //   TradeInfo: this.order.TradeInfo
            // };
            // axios.post('/api/sendData', formData)
            //   .then(res => {
            //     console.log(res);
            //   }).catch(error => {
            //     console.log(error);
            //   });
          }
        },
        async mounted() {
          // https://developer.mozilla.org/en-US/docs/Web/API/URLSearchParams/URLSearchParams
          const url = new URLSearchParams(window.location.search);
          this.orderId = url.get('order');
          const res = await axios.get(`${host}order/${this.orderId}`);
          this.order = res.data;
          console.log(this.order);
        },
      };

      createApp(app).mount('#app');
    </script>
  </body>
</html>
